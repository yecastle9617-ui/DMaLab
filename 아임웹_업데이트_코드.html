<!-- 아임웹 HTML 코드 위젯에 붙여넣을 코드 -->
<!-- 기존 CSS는 유지하고 JavaScript만 업데이트된 버전 -->

<!-- css (기존 유지) -->
<style>
    .dmalab-wrapper {
        width: 100%;
        height: 100vh;
        min-height: 800px;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative;
    }
    
    .dmalab-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
        margin: 0;
        padding: 0;
    }
</style>

<!-- html -->
<iframe 
    id="dmalab-iframe" 
    src="https://dmalab.diffstudio.co.kr" 
    style="width: 100%; border: none; overflow: hidden; display: block; min-height: 600px;"
    scrolling="no"
    frameborder="0"
></iframe>

<!-- script (모달 기능 추가됨) -->
<script>
(function() {
    'use strict';
    
    console.log('[아임웹] iframe 높이 자동 조정 스크립트 시작');
    
    // iframe 요소 찾기 (여러 방법 시도)
    let iframe = document.getElementById('dmalab-iframe');
    if (!iframe) {
        // ID로 못 찾으면 태그로 찾기
        const iframes = document.querySelectorAll('iframe[src*="dmalab.diffstudio.co.kr"]');
        if (iframes.length > 0) {
            iframe = iframes[0];
            console.log('[아임웹] iframe을 태그로 찾음');
        }
    }
    
    if (!iframe) {
        console.error('[아임웹] iframe을 찾을 수 없습니다!');
        return;
    }
    
    console.log('[아임웹] iframe 찾음:', iframe);
    
    // 초기 설정
    iframe.style.overflow = 'hidden';
    iframe.style.border = 'none';
    
    // 높이 조정 함수
    function adjustIframeHeight(height) {
        if (height && height > 0) {
            const newHeight = Math.max(height, 600); // 최소 600px
            iframe.style.height = newHeight + 'px';
            console.log('[아임웹] iframe 높이 조정:', newHeight + 'px');
        }
    }
    
    // 모달 표시 함수 (부모 화면 중앙에 표시)
    function showRestoreModal() {
        // 이미 모달이 있으면 다시 만들지 않음
        if (document.getElementById('dmalab-restore-modal')) {
            return;
        }
        
        const overlay = document.createElement('div');
        overlay.id = 'dmalab-restore-modal';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        `;
        
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: #fff;
            border-radius: 10px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        `;
        
        modal.innerHTML = `
            <h3 style="margin: 0 0 12px; font-size: 18px; font-weight: 700; color: #222;">
                작성 중이던 글이 있습니다
            </h3>
            <p style="margin: 0 0 20px; font-size: 14px; color: #555; line-height: 1.6;">
                이전에 작성하던 임시 저장 내용을 불러올까요?<br>
                "불러오기"를 선택하면 제목/본문/태그가 복원됩니다.
            </p>
            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                <button id="dmalab-modal-restore" style="
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 8px 16px;
                    font-size: 14px;
                    cursor: pointer;
                    font-weight: 500;
                ">불러오기</button>
                <button id="dmalab-modal-discard" style="
                    background: #f5f5f5;
                    color: #333;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 8px 16px;
                    font-size: 14px;
                    cursor: pointer;
                    font-weight: 500;
                ">새로 작성</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // 버튼 클릭 이벤트
        const handleAction = (action) => {
            // iframe에 선택 결과 전달
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    type: 'restore-modal-action',
                    action: action
                }, 'https://dmalab.diffstudio.co.kr');
            }
            overlay.remove();
        };
        
        modal.querySelector('#dmalab-modal-restore').addEventListener('click', () => {
            handleAction('restore');
        });
        
        modal.querySelector('#dmalab-modal-discard').addEventListener('click', () => {
            handleAction('discard');
        });
        
        // 바깥 클릭 시 닫지 않음 (버튼으로만 처리)
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                // 바깥 클릭은 무시
            }
        });
    }
    
    // iframe에서 오는 메시지 수신
    window.addEventListener('message', function(event) {
        // 디버깅용 로그
        console.log('[아임웹] 메시지 수신:', {
            origin: event.origin,
            data: event.data
        });
        
        // 보안: 신뢰할 수 있는 도메인에서만 메시지 수신
        if (event.origin !== 'https://dmalab.diffstudio.co.kr') {
            console.warn('[아임웹] 신뢰할 수 없는 origin:', event.origin);
            return;
        }
        
        // 높이 조정 메시지
        if (event.data && event.data.type === 'iframe-height') {
            const height = event.data.height;
            if (height && height > 0) {
                adjustIframeHeight(height);
            }
        }
        
        // 모달 표시 요청 (새로 추가됨)
        if (event.data && event.data.type === 'show-restore-modal') {
            showRestoreModal();
        }
    }, false);
    
    // iframe 로드 완료 후 초기 높이 요청
    iframe.addEventListener('load', function() {
        console.log('[아임웹] iframe 로드 완료');
        setTimeout(function() {
            if (iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    type: 'request-height'
                }, 'https://dmalab.diffstudio.co.kr');
            }
        }, 500);
    });
    
    console.log('[아임웹] iframe 높이 자동 조정 스크립트 설정 완료');
})();
</script>

